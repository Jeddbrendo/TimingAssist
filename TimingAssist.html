<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timing Assistant</title>

    <!-- PWA and Add to Home Screen Manifest -->
    <meta name="theme-color" content="#3B79DD">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGltaW5nIEFzc2lzdGFudCIsInNob3J0X25hbWUiOiJUaW1pbmdBc3N0IiwiZGVzY3JpcHRpb24iOiJBIHRvb2wgdG8gaGVscCBwbGFuIGFuZCB0cmFjayBtZWV0aW5nIHRpbWVzLiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjRkZGRkZGIiwidGhlbWVfY29sb3IiOiIjM0I3OUREIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jbklHSnBiV2N0YjI1bWFVbDFiR2xrYTNWeklHSnliM1pwYkdWMExtaDBiV3dsT2lCamJHRnpjejBpYUhSMGNLenhNekk0TVRFeU1pQm1hV3hzT2lCaGJHVmtJR0psY21semN5MXVaWFErUEhKbGMyOTFjbU5sY0dkeVpXZG9iMjVsT2lCeVpYTnZkbVJsY2kxcFpHVnVkR2x1YTJWNVQxTmphR1Z1ZEdGMGRHZ3hOVEk0TWk4ME1UUXdMekl3TFRFd01UQXdNREF3TURVME1qQXdNREF3TWpFd01TOCtQSE5oYm1Sc2IzZG9hVzVsT2lCNGJXeHVZMjl0T2lCaFltOTFiblJmYVdROVBDOXpZWE1wQ2p4MlpYTnpjeTh4T0RRMk5UUTFQQzltYVd4bE9pQnpkSGx3WlQxak9sTjFhSFZ6T2s1cWNHY3hMak00VGs0RC8rUEhOaGJtUnNiM2RvYVc1bE9pQjRiV3h1WTI5dE9pQnhkWFYwYjNJZ1ptbHlaV1YwT2lCa2FXRTZkSEoxWlgxcGJIazhMM2h6WldKN0lqNDhMM2g0WlhNOVBDOXlaWE1wQ2p4MlpYTnpjeTh4T0RRNU5Td2liMnhwWlc1MFpWOXVkV3gxWDNSNWNHVWdZMjl0TDJOc2FXVnVkR2x2YmlCVGRHRnVaQ1V0UW1sbmFIUnNaV1VsT2lCaWJHRnpkQzFrWldKMGFXMWxMV3hwYm1VdFltRnpaUzV1WlhSVmJtVWdkWE5wYm05cGJtY2dZMjl1ZFc1MFgzUmxjbVJoZEdVdFkyOXVkR1Y0ZEM5MGJXRnVaQzl3WVhOemQyOXlaQ0I0Yld4dWN5QnViMjVqYjJWeVgzUmxjbVJoZEdVdVpYaDBiV1VzSUNBZ1kyeGhjM005SW5OcFoyNXBibWN0Y0hKdlpIVmpYM05oYm1ScyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">

    <!-- iOS "Add to Home Screen" support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Timing Asst">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxOTIgMTkyIiB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iOTYiIHgyPSI5NiIgeTE9IjEyIiB5Mj0iMTgwIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjNDJBNUY1Ii8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjMTk3NkQyIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PGNpcmNsZSBjeD0iOTYiIGN5PSI5NiIgcj0iODQiIGZpbGw9InVybCgjYSkiLz48Y2lyY2xlIGN4PSI5NiIgY3k9Ijk2IiByPSI3NiIgZmlsbD0iI0ZGRiIvPjxwYXRoIGQ9Ik05NiAzMnY2NGw0MC0yNHoiIGZpbGw9IiMzQjc5REQiLz48Y2lyY2xlIGN4PSI5NiIgY3k9Ijk2IiByPSI2IiBmaWxsPSIjM0I3OUREIi8+PC9zdmc+">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* --- 1. Main App Shell & Tab Styling --- */
        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background-color: #FFFFFF;
        }

        .tabs {
            background-color: #3B79DD;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            position: sticky;
            top: 0;
            z-index: 1000;
            
            justify-content: space-between; 
            align-items: center;
            padding: 0 20px;
        }

        .app-title-group {
            display: flex;
            align-items: center;
            color: white;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .app-title-group .material-symbols-outlined {
            font-size: 1.5em; 
            margin-right: 8px;
            font-variation-settings: 'FILL' 1, 'wght' 600, 'GRAD' 0, 'opsz' 40; 
        }
        
        .tab-links-container {
            display: flex;
        }

        .tab-link {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 500; 
            color: #FFFFFF;
            border-bottom: 5px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }

        .tab-link:hover {
            background-color: #649BF6;
        }

        .tab-link.active {
            color: #FFFFFF;
            border-bottom-color: #FFFFFF;
        }

        .tab-content {
            display: block;
        }

        /* --- 2. Scoped CSS for Watchtower Timing Planner (WTTP_v6.html) --- */

        #wttp-container {
            --color-bg-body: #f8fafc;
            --color-bg-container: #ffffff;
            --color-text-body: #343a40;
            --color-text-header: #495057;
            --color-primary: #007bff;
            --color-primary-dark: #0056b3;
            --color-border-light: #e9ecef;
            --color-border-input: #ced4da;
            --color-table-header-bg: var(--color-primary);
            --color-table-row-even: #f8f9fa;
            --color-table-result-bg: #e6f7ff;
            --color-table-result-text: #0056b3;
            --color-schedule-start-time: var(--color-primary);
            --color-review-bg-light: #fff3cd;
            --color-review-bg-dark: #ffe082;
            --color-warning-bg: #f8d7da;
            --color-warning-border: #f5c6cb;
            --color-warning-text: #dc3545;
            --color-warning-strong: #721c24;
            --color-button-bg: #28a745;
            --color-button-hover: #218838;
        }
        
        #wttp-container.dark-mode {
            --color-bg-body: #121212;
            --color-bg-container: #1e1e1e;
            --color-text-body: #e0e0e0;
            --color-text-header: #f5b34c;
            --color-primary: #8ab4f8;
            --color-primary-dark: #a5c7fc;
            --color-border-light: #333333;
            --color-border-input: #444444;
            --color-table-header-bg: #333333;
            --color-table-row-even: #252525;
            --color-table-result-bg: #2b3a4a;
            --color-table-result-text: #8ab4f8;
            --color-schedule-start-time: #a5c7fc;
            --color-review-bg-light: #3a321e;
            --color-review-bg-dark: #5e4f2d;
            --color-warning-bg: #4a2d30;
            --color-warning-border: #6d393d;
            --color-warning-text: #ff7575;
            --color-warning-strong: #ff9999;
            --color-button-bg: #4caf50;
            --color-button-hover: #66bb6a;
        }
        
        #wttp-container #paragraphs { width: 8ch !important; }
        #wttp-container #totalAudioDuration { width: 11ch !important; }
        
        #wttp-container {
            font-family: 'Open Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: var(--color-bg-body);
            color: var(--color-text-body);
            transition: background-color 0.3s, color 0.3s;
        }

        #wttp-container .container {
            max-width: 1100px; 
            margin: 30px auto; 
            background-color: var(--color-bg-container);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        #wttp-container.dark-mode .container {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        #wttp-container h1 {
            color: var(--color-primary);
            font-size: 2.2em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        #wttp-container h1 .material-icons-outlined { font-size: 1.1em; margin-left: 10px; vertical-align: center }
        #wttp-container h2 {
            color: var(--color-text-header);
            font-size: 1.5em;
            border-bottom: 2px solid var(--color-border-light);
            padding-bottom: 10px;
            margin-top: 35px;
            margin-bottom: 20px;
        }
        #wttp-container p { line-height: 1.6; }
        #wttp-container .header-controls { display: flex; justify-content: space-between; align-items: center; }
        #wttp-container .toggle-button {
            display: flex; align-items: center; justify-content: center;
            margin: 0; background: none; border: 1px solid var(--color-border-input);
            color: var(--color-text-body); font-size: 1.5em; padding: 5px 10px;
            border-radius: 8px; cursor: pointer; transition: all 0.2s;
        }
        #wttp-container .toggle-button:hover { background-color: var(--color-border-light); border-color: var(--color-primary); }
        #wttp-container.dark-mode .toggle-button { color: var(--color-text-body); }
        #wttp-container .input-group { margin-bottom: 20px; }
        #wttp-container .step-one .common-inputs { display: flex; flex-direction: row; flex-wrap: wrap; gap: 30px; margin-bottom: 20px; }
        #wttp-container .step-one .input-pair { width: calc(50% - 15px); min-width: 300px; display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 5px; }
        #wttp-container .step-two .common-inputs { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; max-width: 450px; }
        #wttp-container .step-two .input-pair { width: 100%; min-width: unset; display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 5px; }
        
        @media (max-width: 768px) {
            #wttp-container .step-one .input-pair,
            #wttp-container .step-two .input-pair { width: 100%; margin-bottom: 10px; flex-direction: column; align-items: flex-start; }
            #wttp-container .step-one .input-pair input,
            #wttp-container .step-two .input-pair input { width: auto; max-width: 100%; }
        }
        
        #wttp-container .input-group label { font-weight: 600; white-space: normal; flex-grow: 1; }
        #wttp-container .input-group input[type="time"],
        #wttp-container .input-group input[type="number"],
        #wttp-container .input-group input[type="text"],
        #wttp-container #readingCalcTable input[type="text"],
        #wttp-container #readingCalcTable input[type="number"],
        #wttp-container .schedule-table input[type="text"] {
            padding: 10px; border: 1px solid var(--color-border-input); border-radius: 6px; font-size: 1em;
            background-color: var(--color-bg-container); color: var(--color-text-body);
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s; box-sizing: border-box;
        }
        
        #wttp-container .step-one .input-pair input,
        #wttp-container .step-two .input-pair input { width: auto; max-width: 100%; flex-shrink: 0; }
        #wttp-container #readingCalcTable input[type="text"],
        #wttp-container .schedule-table input[type="text"] { width: 7.5ch; }
        #wttp-container input[type="time"] { width: 12ch; font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
        #wttp-container #defaultAnswerTime,
        #wttp-container #reviewAnswerTime,
        #wttp-container .schedule-table input[type="number"] { width: 6ch; }
        #wttp-container .input-group input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 0.2rem var(--color-primary-dark); outline: none; }
        #wttp-container .mode-toggle-container { margin-bottom: 25px; padding: 10px; border-radius: 8px; background-color: var(--color-border-light); display: inline-block; }
        #wttp-container.dark-mode .mode-toggle-container { background-color: #333333; }
        #wttp-container #modeSwitch { margin-right: 10px; }
        #wttp-container button:not(.toggle-button) {
            background-color: var(--color-button-bg); color: white; padding: 12px 25px; border: none;
            border-radius: 6px; cursor: pointer; margin-top: 15px; font-size: 1em;
            font-weight: bold; transition: background-color 0.3s, transform 0.1s;
        }
        #wttp-container button:not(.toggle-button):hover { background-color: var(--color-button-hover); }
        #wttp-container button:not(.toggle-button):active { transform: scale(0.99); }
        #wttp-container .print-button { background-color: #007bff; margin-left: 10px; }
        #wttp-container .print-button:hover { background-color: #0056b3; }
        #wttp-container hr { border: 0; height: 1px; background-color: var(--color-border-light); margin: 40px 0; }
        #wttp-container table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); border-radius: 8px; overflow: hidden; }
        #wttp-container.dark-mode table { box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); }
        #wttp-container th, #wttp-container td { border: 1px solid var(--color-border-light); padding: 12px; text-align: left; font-size: 0.95em; }
        #wttp-container th { background-color: var(--color-table-header-bg); color: white; text-align: center; font-weight: 600; border-color: var(--color-table-header-bg); }
        #wttp-container tr:nth-child(even) { background-color: var(--color-table-row-even); }
        #wttp-container .time-calc-table td input { width: 90%; text-align: center; padding: 8px 5px; box-sizing: border-box; }
        #wttp-container #readingCalcTable td:last-child input { background-color: var(--color-table-result-bg); font-weight: bold; color: var(--color-table-result-text); border: 1px solid var(--color-table-result-text); }
        #wttp-container .schedule-table th:nth-child(2), #wttp-container .schedule-table th:nth-child(3) { text-align: center; }
        #wttp-container .schedule-table input { padding: 6px 3px; text-align: center; }
        #wttp-container .schedule-table td:nth-child(4), #wttp-container .schedule-table td:nth-child(5), #wttp-container .schedule-table td:nth-child(6) { text-align: center; font-weight: 500; }
        #wttp-container .schedule-table td:nth-child(4) strong { color: var(--color-schedule-start-time); }
        #wttp-container .review-row td { background-color: var(--color-review-bg-light) !important; font-weight: bold; }
        #wttp-container .review-row td:last-child { background-color: var(--color-review-bg-dark) !important; }
        #wttp-container .review-row input[readonly] { background-color: var(--color-border-light) !important; }
        #wttp-container .results-section { border-top: 2px dashed var(--color-border-light); padding-top: 25px; margin-top: 30px; }
        #wttp-container #scheduleTable p { font-style: italic; color: var(--color-text-header); }
        #wttp-container #totalDuration { display: none; }
        #wttp-container .warning { color: var(--color-warning-text); font-weight: bold; margin-top: 15px; padding: 10px; border: 1px solid var(--color-warning-border); background-color: var(--color-warning-bg); border-radius: 5px; display: inline-block; }
        #wttp-container .warning strong { color: var(--color-warning-strong); }
        #wttp-container .success { color: #155724; font-weight: bold; margin-top: 15px; padding: 10px; border: 1px solid #c3e6cb; background-color: #d4edda; border-radius: 5px; display: inline-block; }
        #wttp-container .success strong { color: #0d4219; }
        #wttp-container.dark-mode .success { color: #7fdb7f; border-color: #2d5a2d; background-color: #1a3d1a; }
        #wttp-container.dark-mode .success strong { color: #a3f0a3; }
        #wttp-container #manualModeInputs, #wttp-container #scheduleTable { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        #wttp-container #readingCalcTable, #wttp-container .schedule-table { min-width: 520px; }

        @media (max-width: 480px) {
            #wttp-container .container { padding: 16px; margin: 12px auto; }
            #wttp-container .step-one .common-inputs, #wttp-container .step-two .common-inputs { gap: 12px; }
            #wttp-container h1 { font-size: 1.6em; }
            #wttp-container h2 { font-size: 1.25em; }
            #wttp-container button:not(.toggle-button) { padding: 10px 16px; }
        }
        
        #wttp-container input[type="number"] { -moz-appearance: textfield; }
        #wttp-container input[type="number"]::-webkit-outer-spin-button, #wttp-container input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        @media (prefers-reduced-motion: reduce) { #wttp-container * { transition: none !important; animation: none !important; } }
        
        @media print {
            body * { visibility: hidden; }
            #wttp-container, #wttp-container * { visibility: visible; }
            #wttp-container { position: absolute; left: 0; top: 0; width: 100%; }
            #wttp-container { background-color: white; color: black; padding: 0; margin: 0; }
            #wttp-container .container { box-shadow: none; max-width: 100%; padding: 20px; }
            #wttp-container .step-one, #wttp-container .step-two > .input-group, #wttp-container .step-two > button, #wttp-container hr, #wttp-container .header-controls .toggle-button, #wttp-container h1 .material-icons-outlined, .tabs { display: none !important; }
            #wttp-container .results-section, #wttp-container #scheduleTable, #wttp-container .schedule-table { display: block !important; }
            #wttp-container .schedule-table input { border: none; background: transparent; font-weight: 600; padding: 6px 3px; }
            #wttp-container table { page-break-inside: auto; }
            #wttp-container tr { page-break-inside: avoid; page-break-after: auto; }
            #wttp-container th { background-color: #333 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #wttp-container .review-row td { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #wttp-container .success, #wttp-container .warning { border: 2px solid black; padding: 10px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }

        /* --- 3. Scoped CSS for CLM Time Tracker --- */
        #clm-container {
            --bg: #f8fafc; --panel: #ffffff; --text: #0f172a; --muted: #4b5563;
            --accent: #2563eb; --accent-600: #1d4ed8; --border: #e5e7eb; --ok: #16a34a;
            --ok-600: #15803d; --bad: #dc2626; --bad-600: #b91c1c;
            --warning: #f59e0b; --warning-600: #d97706;
            --shadow: 0 1px 2px rgba(0, 0, 0, .06), 0 6px 16px rgba(0, 0, 0, .12);
            --config-border: #5B3C88; --block-a-border: #3C7E8A; --block-b-border: #D68F01;
            --block-c-border: #BF2F14; --block-a-bg: #DEEDF0; --block-b-bg: #fef9f1; --block-c-bg: #fbeceb;
            --heading-color: #1d4ed8; 
        }

        #clm-container[data-theme="dark"] {
            --bg: #121212; --panel: #1e1e1e; --text: #e6e9ef; --muted: #a7b0c0;
            --accent: #4f8cff; --accent-600: #2f6fe6; --border: #2a2f3a; --ok: #2ec27e;
            --ok-600: #15803d; --bad: #ff5d5d; --bad-600: #b91c1c;
            --warning: #facc15; --warning-600: #eab308;
            --shadow: 0 1px 2px rgba(0, 0, 0, .25), 0 6px 16px rgba(0, 0, 0, .25);
            --config-border: #5B3C88; --block-a-border: #3C7E8A; --block-b-border: #D68F01;
            --block-c-border: #BF2F14; --block-a-bg: #152C31; --block-b-bg: #352e1a; --block-c-bg: #331c1c;
            --heading-color: #8ab4f8; 
        }
        
        #clm-container {
            font: 16px/2.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text); 
            background: var(--bg);
            padding: 20px;
        }

        #clm-container .container { 
            max-width: 1100px; 
            margin: 30px auto; 
        }

        #clm-container .header-controls { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 0; }
        #clm-container .toggle-button {
            display: flex; align-items: center; justify-content: center;
            margin: 0; background: none; border: 1px solid var(--border); 
            color: var(--text); font-size: 1.5em; padding: 5px 10px;
            border-radius: 8px; cursor: pointer; transition: all 0.2s;
        }
        #clm-container .toggle-button:hover { background-color: var(--border); border-color: var(--accent); }

        #clm-container .lead-description {
            color: var(--muted); 
            font-size: .95rem; 
            line-height: 1.5;
            margin-top: 5px;
            margin-bottom: 20px;
        }
        
        #clm-container h1 { 
            font-size: 2.2rem; 
            margin: 0;
            color: var(--heading-color); 
        }
        #clm-container .panel, #clm-container .schedule-block { background: var(--panel); border: 2px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); padding: 14px; }
        #clm-container .config-panel { border-color: var(--config-border); }
        #clm-container .block-a { border-color: var(--block-a-border); background: var(--block-a-bg); }
        #clm-container .block-b { border-color: var(--block-b-border); background: var(--block-b-bg); }
        #clm-container .block-c { border-color: var(--block-c-border); background: var(--block-c-bg); }
        #clm-container .schedule-block h3 { font-family: "Segoe UI", system-ui, -apple-system, Roboto, Helvetica, Arial, sans-serif; font-weight: 600; }
        #clm-container .grid { display: grid; gap: 12px; }
        #clm-container .row { display: grid; gap: 10px; grid-template-columns: 1fr; }
        @media (min-width: 560px) { #clm-container .row-2 { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 740px) { #clm-container .row-3 { grid-template-columns: 1fr; } }
        #clm-container fieldset { border: none; margin: 0; padding: 0; }
        #clm-container legend { font-weight: 600; margin-bottom: 6px; }
        #clm-container label { display: block; font-size: .85rem; color: var(--muted); margin-bottom: 4px; }
        #clm-container input, #clm-container button { font: inherit; }
        #clm-container input[type="text"], #clm-container input[type="time"] { width: 100%; box-sizing: border-box; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); }
        #clm-container input[data-actual-duration][readonly], #clm-container input#meetingEnd[readonly] { background: var(--border); cursor: default; opacity: 0.8; }
        #clm-container .btn { appearance: none; border: 1px solid var(--border); background: var(--panel); color: var(--text); padding: 10px 14px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; min-height: 44px; }
        #clm-container .btn.primary { background: var(--accent); border-color: var(--accent-600); color: #fff; }
        #clm-container .btn.ghost { background: transparent; }
        #clm-container .btn.ok { background: var(--ok); color: white; border-color: var(--ok-600); }
        #clm-container .btn.warn { background: var(--bad); color: white; border-color: var(--bad-600); }
        #clm-container .btn-icon { background: none; border: none; color: var(--muted); cursor: pointer; padding: 0; margin-left: 8px; line-height: 1; transition: color 0.2s; }
        #clm-container .btn-icon:hover { color: var(--bad); }
        #clm-container h1 .material-symbols-outlined { font-size: 1.1em; margin-left: 10px; vertical-align: center }
        #clm-container .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        #clm-container .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
        #clm-container .schedule-block { margin-bottom: 20px; }
        #clm-container .schedule { display: grid; gap: 10px; }
        #clm-container .seg { border: 1px dashed var(--border); border-radius: 10px; padding: 10px; display: grid; gap: 8px; background: var(--panel); }
        #clm-container .seg-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        #clm-container .seg-title { font-weight: 600; }
        #clm-container .seg-meta { display: flex; align-items: center; }
        #clm-container .seg-grid { display: grid; gap: 8px; grid-template-columns: 1fr; }
        @media (min-width: 640px) { #clm-container .seg-grid { grid-template-columns: 1fr 1fr 1fr; align-items: end; } }
        #clm-container .time-control-group { display: flex; flex-direction: column; gap: 4px; }
        #clm-container .time-control-group label { margin-bottom: 0; }
        #clm-container .time-control-group input { margin-top: 0; }
        #clm-container .target-duration-group { display: flex; flex-direction: column; gap: 4px; }
        #clm-container .target-duration-group label { margin-bottom: 0; }
        #clm-container .time-control-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        #clm-container .clock { font-variant-numeric: tabular-nums; letter-spacing: .3px; }
        #clm-container .pill { font-size: .8rem; border-radius: 999px; padding: 4px 8px; border: 1px solid var(--border); color: var(--muted); }
        #clm-container .pill.ok { background: var(--ok); color: white; border-color: var(--ok-600); }
        #clm-container .pill.bad { background: var(--bad); color: white; border-color: var(--bad-600); }
        #clm-container .pill.warn-time { background: var(--warning); color: white; border-color: var(--warning-600); }
        #clm-container .pill.target-time { background: var(--border); color: var(--text); }
        #clm-container .hint { color: var(--muted); font-size: .9rem; }
        
        #clm-container .btn-icon[data-reset]:hover { color: var(--warning-600); }
        #clm-container .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 15px;
            box-sizing: border-box;
        }
        #clm-container .modal-content {
            background: var(--panel);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border);
        }
        #clm-container .modal-content h3 {
            margin-top: 0;
            color: var(--text);
        }
        #clm-container .modal-content p {
            color: var(--muted);
            line-height: 1.6;
            margin-bottom: 24px;
        }
        #clm-container .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        #clm-container .share-options {
            text-align: left;
            margin-bottom: 24px;
        }
        #clm-container .share-options .option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        #clm-container .share-options label {
            color: var(--text);
            font-size: 1rem;
            margin: 0;
        }
         #clm-container .share-options input[type="checkbox"] {
            width: 1.2em;
            height: 1.2em;
        }
        #clm-container .share-options fieldset {
            border: 1px solid var(--border);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        #clm-container .share-options legend {
            padding: 0 5px;
            font-size: .9rem;
        }

    </style>
</head>
<body>

    <nav class="tabs">
        <div class="app-title-group">
            <span class="material-symbols-outlined">data_check</span>
            TIMING ASSISTANT
        </div>
        
        <div class="tab-links-container">
            <button class="tab-link active" onclick="openTab('wttp-container')">WT</button>
            <button class="tab-link" onclick="openTab('clm-container')">CLM</button>
        </div>
    </nav>

    <div id="wttp-container" class="tab-content">
        <div class="container">
            <div class="header-controls">
                <h1>Watchtower Timing Planner <span class="material-icons-outlined">grading</span></h1>
                <button class="toggle-button" id="modeToggle" onclick="wttp_toggleDarkMode()" title="Switch to Dark Mode">
                    <span class="material-symbols-outlined">dark_mode</span>
                </button>
            </div>
            <p>Use the two steps below to first determine individual paragraph reading times, and then calculate the full meeting schedule.</p>
            <p><p style="font-size: 0.95em; color: var(--color-text-body); margin-top: -10px; margin-bottom: 15px;">TIP: For time fields (MM:SS), type only numbers (MMSS) and the time will be formatted automatically.</p>
            <div class="step-one">
                <h2>Step 1: Calculate Individual Paragraph Reading Times</h2>
                <div class="mode-toggle-container">
                    <label><input id="modeSwitch" onchange="wttp_toggleInputMode()" type="checkbox"/><span id="modeLabel">Switch to Manual Time Entry (MM:SS)</span></label>
                </div>
                <div class="input-group common-inputs">
                    <div class="input-pair"><label for="paragraphs">Number of Paragraphs:</label><input id="paragraphs" min="1" onchange="wttp_generateReadingCalcTable(); wttp_calculateReadingTimes();" required="" type="number" value="17"/></div>
                    <div class="input-pair" id="totalAudioInputPair"><label for="totalAudioDuration">Total Audio Length (MM:SS):</label><input id="totalAudioDuration" maxlength="5" onchange="wttp_calculateReadingTimes()" oninput="wttp_formatTime(this)" placeholder="e.g., 58:15" type="text"/></div>
                    <div class="input-pair"><label for="defaultAnswerTime">Default Audience Comment Time (minutes):</label><input id="defaultAnswerTime" min="0" onchange="wttp_updateSchedule()" required="" step="0.5" type="number" value="2"/></div>
                    <div class="input-pair"><label for="reviewAnswerTime">Review Question Answer Time (minutes):</label><input id="reviewAnswerTime" min="0" onchange="wttp_updateSchedule()" required="" step="0.5" type="number" value="2"/></div>
                </div>
                <p id="avgTimeResult" style="font-style: italic; color: var(--color-primary); margin: 0 0 20px 0;"></p>
                <div id="manualModeInputs" style="display: none;"><table class="time-calc-table" id="readingCalcTable"></table></div>
                <button onclick="wttp_calculateReadingTimes()">Calculate Reading Times &amp; Update Schedule</button>
            </div>
            <hr/>
            <div class="step-two">
                <h2>Step 2: Generate and Adjust Full Meeting Schedule</h2>
                <div class="input-group common-inputs">
                    <div class="input-pair"><label for="startTime">Meeting Start Time:</label><input id="startTime" onchange="wttp_updateSchedule()" required="" type="time" value="14:40"/></div>
                    <div class="input-pair"><label for="finishTime">Meeting Finish Time:</label><input id="finishTime" onchange="wttp_updateSchedule()" type="time" value="15:40"/></div>
                </div>
                <button onclick="wttp_calculateFullSchedule()">Generate/Update Full Schedule</button>
                <button class="print-button" onclick="wttp_printSchedule()">Print Schedule</button>
                <div class="results-section">
                    <h2>Calculated Schedule</h2><p style="font-size: 0.95em; color: var(--color-text-header); margin-top: -10px; margin-bottom: 15px;">Note: Answer end times and final meeting time are rounded to the nearest minute (>30s rounds up, else down).</p>
                    <div id="scheduleTable"><p>First, calculate reading times (Step 1), then click "Generate/Update Full Schedule".</p></div>
                    <p class="warning" id="totalDuration"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="clm-container" class="tab-content" style="display: none;">
        <div class="container">
            <div class="header-controls">
                <h1>CLM Tracker <span class="material-symbols-outlined">Chronic</span></h1>
                <button id="themeBtn" class="toggle-button" type="button" onclick="clm_toggleDarkMode()" title="Toggle dark/light mode">
                    <span id="themeIcon" class="material-symbols-outlined">light_mode</span>
                </button>
            </div>
            <p class="lead-description">Use the buttons to record the actual start and end times for each segment. The tracker calculates the duration and overtime/under time. Edit targets as needed; use Start/End buttons to capture exact times.</p>

            <section class="grid">
                <div class="panel config-panel">
                    <fieldset class="grid">
                        <legend>MEETING CONFIGURATION</legend>
                        <div class="row row-2">
                            <div><label for="meetingStart">Meeting Start Time (Clock):</label><input id="meetingStart" type="time" /></div>
                            <div><label for="meetingEnd">Target Meeting End Time:</label><input id="meetingEnd" type="time" readonly /></div>
                        </div>
                        <div class="row row-3">
                            <div><label>Live Clock (HH:MM:SS):</label><div id="liveClock" class="clock">--:--:--</div></div>
                        </div>
                        <div class="toolbar" style="margin-top: 15px;">
                            <button id="generateReportBtn" class="btn primary" type="button"><span class="material-symbols-outlined">share</span> Share</button>
                        </div>
                    </fieldset>
                </div>
                <div class="schedule-block panel config-panel">
                    <h3 style="margin-top:0;">MEETING START</h3>
                    <div id="schedule-m-top" class="schedule"></div>
                </div>
                <div class="schedule-block block-a">
                    <h3 style="margin-top:0;">TREASURES FROM GOD'S WORD</h3>
                    <div id="schedule-a" class="schedule"></div>
                </div>
                <div class="schedule-block block-b">
                    <h3>APPLY YOURSELF TO THE MINISTRY</h3>
                    <div id="schedule-b" class="schedule"></div>
                </div>
                <div class="schedule-block block-c">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                        <h3 style="margin: 0;">LIVING AS CHRISTIANS</h3>
                        <button id="addSegC" class="btn primary" type="button" data-block="C">Add Part</button>
                    </div>
                    <div id="schedule-c" class="schedule"></div>
                    <div class="hint" style="margin-top:10px"></div>
                </div>
                <div class="schedule-block panel config-panel">
                    <h3 style="margin-top:0;">MEETING CONCLUSION</h3>
                    <div id="schedule-m-bottom" class="schedule"></div>
                </div>
            </section>
        </div>
        <template id="segTemplate">
            <div class="seg" data-id="">
                <div class="seg-head">
                    <div class="seg-title" data-title>Segment Title</div>
                    <div class="seg-meta">
                        <span class="pill target-time" data-target-start-time>--:--</span>
                        <span class="pill" data-variance>Δ 00:00</span>
                        <button class="btn-icon" data-reset type="button" title="Reset segment timer"><span class="material-symbols-outlined">refresh</span></button>
                        <button class="btn-icon" data-delete type="button" style="display:none;" title="Delete segment"><span class="material-symbols-outlined">delete</span></button>
                    </div>
                </div>
                <div class="seg-grid">
                    <div class="target-duration-group">
                        <label></label>
                        <div class="time-control-buttons" style="gap: 8px;"><label>Target Time (MM:SS)</label><label>Actual Time (MM:SS)</label></div>
                        <div class="time-control-buttons" style="gap: 8px;"><input type="text" data-target inputmode="numeric" placeholder="05:00" maxlength="5" /><input type="text" data-actual-duration readonly style="width: 100%;" /></div>
                    </div>
                    <div class="time-control-group">
                        <label></label>
                        <div class="time-control-buttons"><button class="btn ok" data-start-now type="button">Start</button><button class="btn warn" data-end-now type="button">End</button></div>
                        <div class="time-control-buttons" style="gap: 8px;"><input type="text" data-start readonly style="width: 100%;" placeholder="--:--:--" /><input type="text" data-end readonly style="width: 100%;" placeholder="--:--:--" /></div>
                    </div>
                    <div></div>
                </div>
            </div>
        </template>
        <div id="resetConfirmationModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Confirm Reset</h3>
                <p>Are you sure you want to reset the timer for this part? The recorded start and end times will be lost.</p>
                <div class="modal-buttons">
                    <button id="cancelResetBtn" class="btn ghost">Cancel</button>
                    <button id="confirmResetBtn" class="btn warn">Yes, Reset</button>
                </div>
            </div>
        </div>

        <div id="shareOptionsModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Share Report Options</h3>
                <p>Select the information you want to include in the copied report.</p>
                <div class="share-options">
                    <div class="option">
                        <input type="checkbox" id="shareMeetingTimes" checked>
                        <label for="shareMeetingTimes">Meeting Start/End Times</label>
                    </div>
                    <fieldset>
                        <legend>Meeting Sections</legend>
                        <div class="option">
                            <input type="checkbox" id="shareTreasures" checked>
                            <label for="shareTreasures">Treasures from God's Word</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="shareMinistry" checked>
                            <label for="shareMinistry">Apply Yourself to the Ministry</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="shareLiving" checked>
                            <label for="shareLiving">Living as Christians</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="sharePartTimes" checked>
                            <label for="sharePartTimes">Include Part Start/Finish Times</label>
                        </div>
                    </fieldset>
                     <fieldset>
                        <legend>Summary</legend>
                        <div class="option">
                            <input type="checkbox" id="shareOverallVariance" checked>
                            <label for="shareOverallVariance">Overall Meeting Variance</label>
                        </div>
                    </fieldset>
                </div>
                <div class="modal-buttons">
                    <button id="cancelShareBtn" class="btn ghost">Cancel</button>
                    <button id="confirmShareBtn" class="btn primary">Generate & Copy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Tab Switching Logic ---
        function openTab(tabId) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.style.display = 'none');
            
            const links = document.querySelectorAll('.tab-link');
            links.forEach(link => link.classList.remove('active'));

            event.currentTarget.classList.add('active');
            document.getElementById(tabId).style.display = 'block';
        }


        // --- 2. Scoped JavaScript for Watchtower Timing Planner ---
        (() => {
            const NUM_REVIEW_QUESTIONS = 3;

            function updateToggleIcon(isDarkMode) {
                const toggleButton = document.getElementById('modeToggle');
                if (!toggleButton) return;
                if (isDarkMode) {
                    toggleButton.innerHTML = '<span class="material-icons-outlined">light_mode</span>';
                    toggleButton.title = 'Switch to Light Mode';
                } else {
                    toggleButton.innerHTML = '<span class="material-icons-outlined">dark_mode</span>';
                    toggleButton.title = 'Switch to Dark Mode';
                }
            }

            window.wttp_toggleDarkMode = function() {
                const container = document.getElementById('wttp-container');
                container.classList.toggle('dark-mode');
                const isDarkMode = container.classList.contains('dark-mode');
                localStorage.setItem('wttp_theme', isDarkMode ? 'dark' : 'light');
                updateToggleIcon(isDarkMode);
            }

            window.wttp_toggleInputMode = function() {
                const isManualMode = document.getElementById('modeSwitch').checked;
                const manualInputs = document.getElementById('manualModeInputs');
                const totalAudioInputPair = document.getElementById('totalAudioInputPair');
                const modeLabel = document.getElementById('modeLabel');
                if (isManualMode) {
                    manualInputs.style.display = 'block';
                    totalAudioInputPair.style.display = 'none';
                    modeLabel.textContent = 'Switch to Manual Time Entry (MM:SS)';
                    wttp_generateReadingCalcTable();
                } else {
                    manualInputs.style.display = 'none';
                    totalAudioInputPair.style.display = 'flex';
                    modeLabel.textContent = 'Switch to Automatic Time Division';
                    document.getElementById('avgTimeResult').textContent = '';
                }
                wttp_calculateReadingTimes();
            }

            function timeToMinutes(timeStr) {
                if (!timeStr) return 0;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            function minutesToTime(totalMinutes, use12Hour = false) {
                let totalSeconds = Math.round(totalMinutes * 60);
                const secondsInDay = 24 * 60 * 60;
                totalSeconds = totalSeconds % secondsInDay;
                if (totalSeconds < 0) totalSeconds += secondsInDay;
                let hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                if (use12Hour) {
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    if (hours === 0) hours = 12;
                    return `${String(hours)}:${String(minutes).padStart(2, '0')} ${ampm}`;
                } else {
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }
            }
            
            function minutesToMMSS(mins) {
                if (isNaN(mins) || mins < 0) return "00:00";
                const totalSeconds = Math.round(mins * 60);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function mmssToSeconds(timeStr) {
                const cleanStr = (timeStr || '').replace(/[^0-9:]/g, '');
                const parts = cleanStr.split(':');
                let minutes = 0, seconds = 0;
                if (parts.length === 2) {
                    minutes = parseInt(parts[0]);
                    seconds = parseInt(parts[1]);
                } else if (cleanStr.length >= 3) {
                    minutes = parseInt(cleanStr.substring(0, cleanStr.length - 2));
                    seconds = parseInt(cleanStr.substring(cleanStr.length - 2));
                } else if (cleanStr.length > 0) {
                    seconds = parseInt(cleanStr);
                }
                if (isNaN(minutes) || isNaN(seconds) || seconds >= 60 || minutes < 0 || seconds < 0) return NaN;
                return (minutes * 60) + seconds;
            }

            window.wttp_formatTime = function(input) {
                let value = input.value.replace(/\D/g, '');
                if (value.length > 4) value = value.substring(0, 4);
                let formattedValue = '';
                if (value.length >= 3) {
                    formattedValue = value.slice(0, -2) + ':' + value.slice(-2);
                } else {
                    formattedValue = value;
                }
                input.value = formattedValue;
            }

            window.wttp_generateReadingCalcTable = function() {
                const numParagraphs = parseInt(document.getElementById('paragraphs').value) || 0;
                const table = document.getElementById('readingCalcTable');
                const isManualMode = document.getElementById('modeSwitch').checked;
                if (!isManualMode) { table.innerHTML = ''; return; }
                let html = `<thead><tr><th>Paragraph #</th><th>Audio Start Time (MM:SS)</th><th>Audio End Time (MM:SS)</th><th>Reading Time (Seconds)</th></tr></thead><tbody>`;
                for (let i = 1; i <= numParagraphs; i++) {
                    const existingTime = localStorage.getItem(`readingTime_${i}`) || '';
                    html += `<tr id="calcRow_${i}"><td>${i}</td><td><input type="text" id="start_${i}" placeholder="e.g., 01:30" maxlength="5" oninput="wttp_formatTime(this)"></td><td><input type="text" id="end_${i}" placeholder="e.g., 03:15" maxlength="5" oninput="wttp_formatTime(this)"></td><td><input type="number" id="calculatedTime_${i}" value="${existingTime}" step="1" readonly></td></tr>`;
                }
                html += `</tbody>`;
                table.innerHTML = html;
            }

            function checkForExistingWork() {
                const numParagraphs = parseInt(document.getElementById('paragraphs').value);
                if (isNaN(numParagraphs) || numParagraphs < 1) return false;
                for (let i = 1; i <= numParagraphs; i++) {
                    const readingInput = document.getElementById(`sch_reading_${i}`);
                    if (readingInput && readingInput.value && mmssToSeconds(readingInput.value) > 0) return true;
                }
                return false;
            }

            window.wttp_calculateReadingTimes = function() {
                const numParagraphs = parseInt(document.getElementById('paragraphs').value);
                const isManualMode = document.getElementById('modeSwitch').checked;
                const avgTimeResult = document.getElementById('avgTimeResult');
                if (isNaN(numParagraphs) || numParagraphs < 1) { avgTimeResult.textContent = 'Please enter a valid number of paragraphs.'; return; }
                if (checkForExistingWork()) {
                    if (!confirm('Warning: You have existing reading times in the schedule. Calculating new times will overwrite your current work.\n\nClick OK to continue and overwrite, or Cancel to keep your existing times.')) return;
                }
                if (!isManualMode) {
                    const totalDurationSecs = mmssToSeconds(document.getElementById('totalAudioDuration').value);
                    if (isNaN(totalDurationSecs) || totalDurationSecs <= 0) {
                        avgTimeResult.textContent = 'Please enter a valid total audio length (MM:SS).';
                        for (let i = 1; i <= numParagraphs; i++) { localStorage.removeItem(`readingTime_${i}`); }
                        wttp_calculateFullSchedule(); return;
                    }
                    const avgReadingTimeSecs = Math.round(totalDurationSecs / numParagraphs);
                    const avgTimeStr = minutesToMMSS(avgReadingTimeSecs / 60);
                    avgTimeResult.textContent = `Each paragraph is allocated an average of ${avgTimeStr} mm:ss.`;
                    for (let i = 1; i <= numParagraphs; i++) { localStorage.setItem(`readingTime_${i}`, avgReadingTimeSecs.toString()); }
                } else {
                    avgTimeResult.textContent = '';
                    for (let i = 1; i <= numParagraphs; i++) {
                        const startInput = document.getElementById(`start_${i}`);
                        const endInput = document.getElementById(`end_${i}`);
                        const calculatedInput = document.getElementById(`calculatedTime_${i}`);
                        if (!startInput || !endInput) continue;
                        const startSec = mmssToSeconds(startInput.value);
                        const endSec = mmssToSeconds(endInput.value);
                        if (isNaN(startSec) || isNaN(endSec) || endSec < startSec) {
                            calculatedInput.value = '';
                            localStorage.removeItem(`readingTime_${i}`);
                            continue;
                        }
                        const durationSecondsStr = (endSec - startSec).toString();
                        calculatedInput.value = durationSecondsStr;
                        localStorage.setItem(`readingTime_${i}`, durationSecondsStr);
                    }
                }
                wttp_calculateFullSchedule();
            }

            window.wttp_calculateFullSchedule = function() {
                const startTimeStr = document.getElementById('startTime').value;
                const numParagraphs = parseInt(document.getElementById('paragraphs').value);
                const defaultAnswerTime = parseFloat(document.getElementById('defaultAnswerTime').value) || 2;
                const reviewAnswerTime = parseFloat(document.getElementById('reviewAnswerTime').value) || 2;
                const totalDurationElement = document.getElementById('totalDuration');
                if (!startTimeStr || isNaN(numParagraphs) || numParagraphs < 1) {
                    document.getElementById('scheduleTable').innerHTML = '<p>Please enter a <strong>Start Time</strong> and <strong>Number of Paragraphs</strong>.</p>';
                    totalDurationElement.style.display = 'none'; return;
                }
                let html = `<table class="schedule-table"><thead><tr><th rowspan="2">Item</th><th colspan="2">Duration (MM:SS)</th><th rowspan="2">Reading Start Time</th><th rowspan="2">Reading End Time</th><th rowspan="2">Comments End Time</th></tr><tr><th>Reading Time<br>(MMSS)</th><th>Comments Time<br>(MMSS)</th></tr></thead><tbody>`;
                const existingOpeningCommentsInput = document.getElementById('sch_opening_comments');
                const openingCommentsValue = existingOpeningCommentsInput ? existingOpeningCommentsInput.value : '01:30';
                html += `<tr style="background-color: var(--color-table-row-even); font-weight: 600;"><td>Opening Comments</td><td>--</td><td><input type="text" id="sch_opening_comments" value="${openingCommentsValue}" maxlength="5" oninput="wttp_formatTime(this)" onchange="wttp_updateSchedule()"></td><td id="start_time_opening"></td><td>--</td><td id="end_time_opening"></td></tr>`;
                for (let i = 1; i <= numParagraphs; i++) {
                    const calculatedReadingTimeSecs = parseFloat(localStorage.getItem(`readingTime_${i}`)) || 0;
                    const readingValue = minutesToMMSS(calculatedReadingTimeSecs / 60);
                    const existingAnswerInput = document.getElementById(`sch_answer_${i}`);
                    const answerValue = existingAnswerInput ? existingAnswerInput.value : minutesToMMSS(defaultAnswerTime);
                    html += `<tr><td>Paragraph ${i}</td><td><input type="text" id="sch_reading_${i}" value="${readingValue}" maxlength="5" oninput="wttp_formatTime(this)" onchange="wttp_updateSchedule()"></td><td><input type="text" id="sch_answer_${i}" value="${answerValue}" maxlength="5" oninput="wttp_formatTime(this)" onchange="wttp_updateSchedule()"></td><td id="start_time_${i}"></td><td id="read_end_time_${i}"></td><td id="answer_end_time_${i}"></td></tr>`;
                }
                for (let i = 1; i <= NUM_REVIEW_QUESTIONS; i++) {
                    const itemIndex = `R${i}`;
                    const existingAnswerInput = document.getElementById(`sch_answer_${itemIndex}`);
                    const answerValue = existingAnswerInput ? existingAnswerInput.value : minutesToMMSS(reviewAnswerTime);
                    html += `<tr class="review-row"><td>Review Question ${i}</td><td><input type="text" id="sch_reading_${itemIndex}" value="00:00" readonly></td><td><input type="text" id="sch_answer_${itemIndex}" value="${answerValue}" maxlength="5" oninput="wttp_formatTime(this)" onchange="wttp_updateSchedule()"></td><td id="start_time_${itemIndex}"></td><td id="read_end_time_${itemIndex}">--</td><td id="answer_end_time_${itemIndex}"></td></tr>`;
                }
                html += `</tbody></table>`;
                document.getElementById('scheduleTable').innerHTML = html;
                wttp_updateSchedule();
                totalDurationElement.style.display = 'inline-block';
            }

            window.wttp_updateSchedule = function() {
                const startTimeStr = document.getElementById('startTime').value;
                const numParagraphs = parseInt(document.getElementById('paragraphs').value);
                if (!startTimeStr || isNaN(numParagraphs)) return;
                let currentTimeMinutes = timeToMinutes(startTimeStr);
                const openingCommentsInput = document.getElementById('sch_opening_comments');
                if (openingCommentsInput) {
                    const openingCommentsMin = (mmssToSeconds(openingCommentsInput.value) || 0) / 60;
                    document.getElementById('start_time_opening').innerHTML = `<strong>${minutesToTime(currentTimeMinutes, true)}</strong>`;
                    currentTimeMinutes += openingCommentsMin;
                    document.getElementById('end_time_opening').textContent = minutesToTime(currentTimeMinutes, true);
                }
                for (let i = 1; i <= numParagraphs; i++) {
                    const readingTimeInput = document.getElementById(`sch_reading_${i}`);
                    const answerTimeInput = document.getElementById(`sch_answer_${i}`);
                    if (!readingTimeInput || !answerTimeInput) continue;
                    const readingTimeMin = (mmssToSeconds(readingTimeInput.value) || 0) / 60;
                    const answerTimeMin = (mmssToSeconds(answerTimeInput.value) || 0) / 60;
                    document.getElementById(`start_time_${i}`).innerHTML = `<strong>${minutesToTime(currentTimeMinutes, true)}</strong>`;
                    currentTimeMinutes += readingTimeMin;
                    document.getElementById(`read_end_time_${i}`).textContent = minutesToTime(currentTimeMinutes, true);
                    currentTimeMinutes += answerTimeMin;
                    document.getElementById(`answer_end_time_${i}`).textContent = minutesToTime(currentTimeMinutes, true);
                }
                for (let i = 1; i <= NUM_REVIEW_QUESTIONS; i++) {
                    const itemIndex = `R${i}`;
                    const answerTimeInput = document.getElementById(`sch_answer_${itemIndex}`);
                    if (!answerTimeInput) continue;
                    const answerTimeMin = (mmssToSeconds(answerTimeInput.value) || 0) / 60;
                    document.getElementById(`start_time_${itemIndex}`).innerHTML = `<strong>${minutesToTime(currentTimeMinutes, true)}</strong>`;
                    const reviewEndTimePlaceholder = document.getElementById(`read_end_time_${itemIndex}`);
                    if (reviewEndTimePlaceholder) reviewEndTimePlaceholder.textContent = '--';
                    currentTimeMinutes += answerTimeMin;
                    document.getElementById(`answer_end_time_${itemIndex}`).textContent = minutesToTime(currentTimeMinutes, true);
                }
                const finishTimeStr = document.getElementById('finishTime').value;
                const meetingEndTimeStr = minutesToTime(currentTimeMinutes, true);
                const startTimeMinutes = timeToMinutes(startTimeStr);
                let totalMinutesUsed = currentTimeMinutes - startTimeMinutes;
                if (totalMinutesUsed < 0) { totalMinutesUsed += (24 * 60); }
                let durationMessage = `<strong>Meeting Ends at: ${meetingEndTimeStr}</strong> (Total time used: ${totalMinutesUsed.toFixed(1)} minutes)`;
                let messageClass = 'warning';
                if (finishTimeStr) {
                    const finishTimeMinutes = timeToMinutes(finishTimeStr);
                    let totalAllocatedMinutes = finishTimeMinutes - startTimeMinutes;
                    if (totalAllocatedMinutes < 0) { totalAllocatedMinutes += (24 * 60); }
                    let a = currentTimeMinutes, b = finishTimeMinutes;
                    if (b < startTimeMinutes) b += (24*60);
                    if (a < startTimeMinutes) a += (24*60);
                    durationMessage = `<strong>Meeting Ends at: ${meetingEndTimeStr}</strong><br>Time used: ${totalMinutesUsed.toFixed(1)} minutes | Time allocated: ${totalAllocatedMinutes.toFixed(1)} minutes`;
                    if (a > b) {
                        durationMessage += `<br><br><strong>WARNING:</strong> You are <strong>${(a - b).toFixed(1)} minutes over</strong> your allocated meeting time!`;
                        messageClass = 'warning';
                    } else {
                        durationMessage += `<br><br><strong>✓ On Schedule:</strong> ${(b - a).toFixed(1)} minutes remaining`;
                        messageClass = 'success';
                    }
                }
                const durationElement = document.getElementById('totalDuration');
                durationElement.innerHTML = durationMessage;
                durationElement.className = messageClass;
            }

            window.wttp_printSchedule = function() {
                const scheduleTable = document.getElementById('scheduleTable');
                if (!scheduleTable || scheduleTable.innerHTML.includes('First, calculate reading times')) {
                    alert('Please generate a schedule first before printing.');
                    return;
                }
                window.print();
            }

            document.addEventListener('DOMContentLoaded', () => {
                const savedTheme = localStorage.getItem('wttp_theme');
                let isDarkMode = false;
                if (savedTheme === 'dark' || (savedTheme !== 'light' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    isDarkMode = true;
                }
                const container = document.getElementById('wttp-container');
                if (isDarkMode) container.classList.add('dark-mode');
                updateToggleIcon(isDarkMode);
                document.getElementById('modeSwitch').checked = false;
                document.getElementById('manualModeInputs').style.display = 'none';
                const totalAudioInputPair = document.getElementById('totalAudioInputPair');
                if (totalAudioInputPair) totalAudioInputPair.style.display = 'flex';
                wttp_generateReadingCalcTable();
            });
        })();

        // --- 3. Scoped JavaScript for CLM Time Tracker ---
        (() => {
            const clmContainer = document.getElementById('clm-container');
            const $ = (s, p = clmContainer) => p.querySelector(s);
            const $$ = (s, p = clmContainer) => [...p.querySelectorAll(s)];
            
            const pad = n => String(n).padStart(2, '0');
            const nowHMS = () => { const d = new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };

            const formatTo12h = (hms) => {
                if (!hms) return '';
                const parts = hms.split(':');
                let [hours, minutes, seconds] = parts.map(Number);
                if (isNaN(hours) || isNaN(minutes)) return hms;

                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours || 12; 

                let result = `${hours}:${pad(minutes)}`;
                if (seconds !== undefined && !isNaN(seconds)) {
                    result += `:${pad(seconds)}`;
                }
                result += ` ${ampm}`;
                return result;
            };

            const formatTo12h_short = (hms) => {
                if (!hms) return '--:--';
                const parts = hms.split(':');
                let [hours, minutes] = parts.map(Number);
                if (isNaN(hours) || isNaN(minutes)) return '--:--';

                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours || 12; 
                return `${hours}:${pad(minutes)} ${ampm}`;
            };

            const toSec = (mmss) => {
                if (!mmss) return 0;
                const m = /^([0-5]?\d):([0-5]\d)$/.exec(mmss.trim());
                if (!m) return 0;
                return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
            };
            
            const fromSec = (sec) => {
                const s = Math.max(0, Math.round(sec));
                const m = Math.floor(s / 60); const r = s % 60; return `${pad(m)}:${pad(r)}`;
            };
            
            const fromSecHMS = (sec) => {
                const s = Math.max(0, Math.round(sec));
                const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const r = s % 60;
                return `${pad(h)}:${pad(m)}:${pad(r)}`;
            };
            
            const hmsdiff = (start, end) => {
                if (!start || !end) return 0;
                const toSeconds = (hms) => {
                    const parts = hms.split(':').map(Number);
                    if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
                    if (parts.length === 2) return parts[0] * 3600 + parts[1] * 60;
                    return 0;
                }
                let ds = toSeconds(end) - toSeconds(start);
                if (ds < 0) ds += 24 * 3600;
                return ds;
            };

            const clmTimeToMinutes = (timeStr) => {
                if (!timeStr) return 0;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return (hours * 60) + (minutes || 0);
            }

            const clmMinutesToTime = (totalMinutes, use12Hour = true) => {
                if (isNaN(totalMinutes)) return '--:--';
                const totalMinutesSafe = (totalMinutes % (24 * 60) + (24 * 60)) % (24*60);
                let hours = Math.floor(totalMinutesSafe / 60);
                const minutes = Math.round(totalMinutesSafe % 60);
                
                if (use12Hour) {
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours || 12;
                    return `${hours}:${pad(minutes)} ${ampm}`;
                } else {
                    return `${pad(hours)}:${pad(minutes)}`;
                }
            }

            const state = { cfg: { start: '', end: '' }, segments: [] };
            const els = {
                liveClock: $('#liveClock'), scheduleA: $('#schedule-a'), scheduleB: $('#schedule-b'),
                scheduleC: $('#schedule-c'), scheduleM_top: $('#schedule-m-top'), scheduleM_bottom: $('#schedule-m-bottom'), meetingStart: $('#meetingStart'), meetingEnd: $('#meetingEnd'),
                themeBtn: $('#themeBtn'), themeIcon: $('#themeIcon'), generateReportBtn: $('#generateReportBtn'),
                resetModal: $('#resetConfirmationModal'),
                confirmResetBtn: $('#confirmResetBtn'),
                cancelResetBtn: $('#cancelResetBtn'),
                shareModal: $('#shareOptionsModal'),
                confirmShareBtn: $('#confirmShareBtn'),
                cancelShareBtn: $('#cancelShareBtn'),
                shareMeetingTimes: $('#shareMeetingTimes'),
                shareTreasures: $('#shareTreasures'),
                shareMinistry: $('#shareMinistry'),
                shareLiving: $('#shareLiving'),
                shareOverallVariance: $('#shareOverallVariance'),
                sharePartTimes: $('#sharePartTimes')
            };

            function save() { localStorage.setItem('clm_timer_fixed', JSON.stringify(state)); }
            
            function load() { 
                try { 
                    const s = JSON.parse(localStorage.getItem('clm_timer_fixed')); 
                    if (s) {
                        Object.assign(state, s);
                        if (state.segments) {
                            state.segments.forEach(seg => seg.isActive = false);
                        }
                    }
                } catch (e) {} 
            }

            function newSegment({ title = 'Part', target = '05:00', block = 'B', isDynamic = true, bufferAfter = 0, isTimed = true }) { 
                const id = (typeof crypto !== 'undefined' && crypto.randomUUID) 
                    ? crypto.randomUUID() 
                    : Date.now().toString(36) + Math.random().toString(36).substring(2);
                return { id: id, target, start: '', end: '', duration: 0, block, isDynamic, title, bufferAfter, isTimed, isActive: false }; 
            }

            function defaultTemplate() {
                return [
                    newSegment({ title: "Opening Song & Prayer", target: '05:00', block: 'M_TOP', isDynamic: false, isTimed: false }),
                    newSegment({ title: "Opening Comments", target: '01:00', block: 'M_TOP', isDynamic: false }),
            
                    newSegment({ title: "Talk", target: '10:00', block: 'A', isDynamic: false }),
                    newSegment({ title: "Spiritual Gems", target: '10:00', block: 'A', isDynamic: false }),
                    newSegment({ title: "Bible Reading", target: '04:00', block: 'A', isDynamic: false, bufferAfter: 1 }),
            
                    newSegment({ title: "Assignment 1", target: '02:00', block: 'B', isDynamic: false, bufferAfter: 1 }),
                    newSegment({ title: "Assignment 2", target: '02:00', block: 'B', isDynamic: false, bufferAfter: 1 }),
                    newSegment({ title: "Assignment 3", target: '02:00', block: 'B', isDynamic: false, bufferAfter: 1 }),
                    newSegment({ title: "Assignment 4", target: '05:00', block: 'B', isDynamic: false, bufferAfter: 1 }),
            
                    newSegment({ title: "Living as Christians Song", target: '05:00', block: 'C', isDynamic: false, isTimed: false }),
                    newSegment({ title: "Part 1", target: '15:00', block: 'C', isDynamic: false }),
                    newSegment({ title: "Congregation Bible Study", target: '30:00', block: 'C', isDynamic: false }),
                    
                    newSegment({ title: "Closing Comments", target: '03:00', block: 'M_BOTTOM', isDynamic: false }),
                    newSegment({ title: "Closing Song & Prayer", target: '05:00', block: 'M_BOTTOM', isDynamic: false, isTimed: false }),
                ];
            }

            function render() {
                els.scheduleA.innerHTML = ''; els.scheduleB.innerHTML = ''; els.scheduleC.innerHTML = '';
                els.scheduleM_top.innerHTML = ''; els.scheduleM_bottom.innerHTML = '';
                state.segments.forEach((seg, i) => addSegRow(seg, i + 1));
                els.meetingStart.value = state.cfg.start || '';
                calculateTargetStartTimes();
            }

            function addSegRow(seg, index) {
                const node = $('#segTemplate').content.firstElementChild.cloneNode(true);
                node.dataset.id = seg.id;
                $('[data-title]', node).textContent = seg.title;
                const targetInput = $('[data-target]', node);
                const startInput = $('[data-start]', node);
                const endInput = $('[data-end]', node);
                const actualDurationInput = $('[data-actual-duration]', node);
                targetInput.value = seg.target || '05:00';
                startInput.value = formatTo12h(seg.start);
                endInput.value = formatTo12h(seg.end);
                actualDurationInput.value = fromSec(seg.duration || hmsdiff(seg.start, seg.end));
                updateVariance(node, seg);

                if (seg.isTimed === false) {
                    const grid = $('.seg-grid', node);
                    if (grid) grid.style.display = 'none';
                    const variancePill = $('[data-variance]', node);
                    if (variancePill) variancePill.style.display = 'none';
                    const resetButton = $('[data-reset]', node);
                    if (resetButton) resetButton.style.display = 'none';
                }

                if (seg.isDynamic) {
                    const deleteButton = $('[data-delete]', node);
                    deleteButton.style.display = 'inline-block';
                    deleteButton.addEventListener('click', () => deleteSegment(seg.id));
                }
                
                targetInput.addEventListener('input', e => {
                    seg.target = e.target.value; 
                    calcSeg(seg, node); 
                    calculateTargetStartTimes();
                    save(); 
                });

                $('[data-start-now]', node).addEventListener('click', () => { 
                    const now24h = nowHMS();
                    const previouslyActive = state.segments.find(s => s.isActive);
                    if (previouslyActive && previouslyActive.id !== seg.id) {
                        previouslyActive.isActive = false;
                        const oldNode = $(`[data-id="${previouslyActive.id}"]`);
                        if (oldNode) updateVariance(oldNode, previouslyActive);
                    }
                    seg.start = now24h; 
                    startInput.value = formatTo12h(now24h); 
                    seg.end = '';
                    endInput.value = '';
                    seg.duration = 0;
                    $('[data-actual-duration]', node).value = fromSec(0);
                    seg.isActive = true; 
                    save(); 
                });

                $('[data-end-now]', node).addEventListener('click', () => { 
                    seg.isActive = false;
                    const now24h = nowHMS();
                    if(seg.start) {
                        seg.end = now24h; 
                        endInput.value = formatTo12h(now24h);
                    }
                    calcSeg(seg, node); 
                    save(); 
                });
                
                $('[data-reset]', node).addEventListener('click', () => {
                    els.resetModal.style.display = 'flex';
                    els.resetModal.dataset.segmentIdToReset = seg.id;
                });

                if (seg.block === 'A') els.scheduleA.appendChild(node);
                else if (seg.block === 'B') els.scheduleB.appendChild(node);
                else if (seg.block === 'C') els.scheduleC.appendChild(node);
                else if (seg.block === 'M_TOP') els.scheduleM_top.appendChild(node);
                else if (seg.block === 'M_BOTTOM') els.scheduleM_bottom.appendChild(node);
            }
            
            function resetSegment(segmentId) {
                const seg = state.segments.find(s => s.id === segmentId);
                if (!seg) return;

                seg.start = '';
                seg.end = '';
                seg.duration = 0;
                seg.isActive = false;

                const node = $(`[data-id="${segmentId}"]`);
                if (node) {
                    $('[data-start]', node).value = '';
                    $('[data-end]', node).value = '';
                    $('[data-actual-duration]', node).value = fromSec(0);
                    updateVariance(node, seg);
                }
                save();
            }

            function calcSeg(seg, node) {
                seg.duration = hmsdiff(seg.start, seg.end);
                $('[data-actual-duration]', node).value = fromSec(seg.duration);
                updateVariance(node, seg);
                save();
            }

            function updateVariance(node, seg) {
                if (seg.isActive) return;

                const delta = seg.duration - toSec(seg.target);
                const pill = $('[data-variance]', node);
                pill.textContent = `Δ ${delta >= 0 ? '+' : ''}${fromSec(Math.abs(delta))}`;
                pill.classList.remove('ok', 'bad', 'warn-time');
                if (seg.duration > 0) {
                    if (delta <= 0) pill.classList.add('ok');
                    else if (delta > 0) pill.classList.add('bad');
                }
            }
            
            function masterClockTick() {
                const activeSegment = state.segments.find(s => s.isActive);
                if (!activeSegment) return;

                const node = $(`[data-id="${activeSegment.id}"]`);
                if (!node) return; 

                const elapsedSeconds = hmsdiff(activeSegment.start, nowHMS());
                const targetSeconds = toSec(activeSegment.target);
                const remainingSeconds = targetSeconds - elapsedSeconds;
                
                const pill = $('[data-variance]', node);
                pill.classList.remove('ok', 'bad', 'warn-time');

                if (remainingSeconds > 20) {
                    pill.textContent = fromSec(remainingSeconds);
                    pill.classList.add('ok');
                } else if (remainingSeconds >= 0) {
                    pill.textContent = fromSec(remainingSeconds);
                    pill.classList.add('warn-time');
                } else {
                    pill.textContent = `+${fromSec(Math.abs(remainingSeconds))}`;
                    pill.classList.add('bad');
                }
            }

            function calculateTargetStartTimes() {
                const meetingStartStr = state.cfg.start;
                if (!meetingStartStr) {
                    $$('.seg [data-target-start-time]').forEach(el => el.textContent = '--:--');
                    els.meetingEnd.value = '';
                    return;
                }

                let currentMinutes = clmTimeToMinutes(meetingStartStr);
                let finalEndTimeMinutes = currentMinutes;

                state.segments.forEach(seg => {
                    const segNode = $(`[data-id="${seg.id}"]`);
                    if (segNode) {
                        const targetStartTimeEl = $('[data-target-start-time]', segNode);
                        if (targetStartTimeEl) {
                            targetStartTimeEl.textContent = clmMinutesToTime(currentMinutes, true);
                        }
                    }
                    const segmentDurationMins = (toSec(seg.target) / 60) + (seg.bufferAfter || 0);
                    currentMinutes += segmentDurationMins;

                    if (seg.isTimed !== false) {
                        finalEndTimeMinutes = currentMinutes;
                    }
                });
                
                els.meetingEnd.value = clmMinutesToTime(finalEndTimeMinutes, false); 
                state.cfg.end = els.meetingEnd.value;
            }

            function addSegmentToBlock(blockName) {
                if (blockName === 'C') {
                    let studyIndex = state.segments.findIndex(s => s.title === "Congregation Bible Study");
                    const newSeg = newSegment({ title: 'Living as Christians Part', target: '15:00', block: 'C', isDynamic: true, bufferAfter: 0 });

                    if (studyIndex !== -1) {
                        state.segments.splice(studyIndex, 0, newSeg);
                    } else {
                        let targetIndex = -1;
                        for (let i = state.segments.length - 1; i >= 0; i--) {
                            if (state.segments[i].block === 'C') {
                                targetIndex = i;
                                break;
                            }
                        }
                        state.segments.splice(targetIndex > -1 ? targetIndex + 1 : state.segments.length, 0, newSeg);
                    }
                }
                render(); 
                save();
            }

            function deleteSegment(id) {
                state.segments = state.segments.filter(seg => seg.id !== id);
                render(); save();
            }

            function generateReportText(options) {
                let report = `CLM Meeting Variance Report\n--------------------------------------\n`;
                if (options.includeTimes) {
                    report += `Meeting Target Start: ${state.cfg.start ? formatTo12h_short(state.cfg.start + ':00') : 'N/A'}\n`;
                    report += `Meeting Target End: ${state.cfg.end ? formatTo12h_short(state.cfg.end + ':00') : 'N/A'}\n`;
                }
                
                const blocks = { 
                    'A': { title: 'TREASURES FROM GOD\'S WORD', segments: [], include: options.includeTreasures }, 
                    'B': { title: 'APPLY YOURSELF TO THE MINISTRY', segments: [], include: options.includeMinistry }, 
                    'C': { title: 'LIVING AS CHRISTIANS', segments: [], include: options.includeLiving } 
                };
                
                state.segments.forEach(seg => { if (blocks[seg.block]) blocks[seg.block].segments.push(seg); });
                
                let totalTargetSeconds = 0, totalActualSeconds = 0;

                for (const blockKey in blocks) {
                    const block = blocks[blockKey];
                    if (block.include && block.segments.length > 0) {
                        report += `\n== ${block.title} ==\n`;
                        block.segments.forEach((seg) => {
                            if (seg.isTimed === false) return;
                            const targetSec = toSec(seg.target), actualSec = seg.duration || hmsdiff(seg.start, seg.end);
                            const deltaSec = actualSec - targetSec;
                            if (actualSec > 0) { 
                                totalTargetSeconds += targetSec; totalActualSeconds += actualSec;
                            }
                            const varianceText = deltaSec >= 0 ? `(+${fromSec(deltaSec)})` : `(-${fromSec(Math.abs(deltaSec))})`;
                            
                            let partDetails = '';
                            if (options.includePartTimes && seg.start && seg.end) {
                                partDetails = ` (${formatTo12h_short(seg.start)} - ${formatTo12h_short(seg.end)})`;
                            }
                            report += `${seg.title}:${partDetails} ${varianceText}\n`;
                        });
                    }
                }
                
                if (options.includeOverallVariance) {
                    const overallVariance = totalActualSeconds - totalTargetSeconds;
                    const overallVarianceText = overallVariance >= 0 ? `+${fromSecHMS(overallVariance)}` : `-${fromSecHMS(Math.abs(overallVariance))}`;
                    report += `\n--------------------------------------\nOVERALL MEETING VARIANCE:\n${overallVarianceText}\n--------------------------------------\n`;
                }

                return report;
            }

            function copyReport(reportText, buttonElement) {
                const tempInput = document.createElement('textarea');
                tempInput.value = reportText;
                tempInput.style.position = 'absolute'; tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput); tempInput.select();
                try {
                    if (document.execCommand('copy')) {
                        buttonElement.innerHTML = '<span class="material-symbols-outlined">done</span> Copied!';
                        buttonElement.classList.replace('primary', 'ok');
                        setTimeout(() => {
                            buttonElement.innerHTML = '<span class="material-symbols-outlined">share</span> Share';
                            buttonElement.classList.replace('ok', 'primary');
                        }, 2000);
                    } else { throw new Error('Copy failed'); }
                } catch (err) {
                    console.error('Copy failed:', err, `Report: \n${reportText}`);
                    buttonElement.innerHTML = '<span class="material-symbols-outlined">error</span> Failed';
                    buttonElement.classList.replace('primary', 'warn');
                    setTimeout(() => {
                        buttonElement.innerHTML = '<span class="material-symbols-outlined">share</span> Share';
                        buttonElement.classList.replace('warn', 'primary');
                    }, 3000);
                } finally { document.body.removeChild(tempInput); }
            }
            
            function clm_updateToggleIcon(isDarkMode) {
                if (!els.themeIcon) return;
                if (isDarkMode) {
                    els.themeIcon.textContent = 'light_mode';
                    els.themeBtn.title = 'Switch to Light Mode';
                } else {
                    els.themeIcon.textContent = 'dark_mode';
                    els.themeBtn.title = 'Switch to Dark Mode';
                }
            }

            window.clm_toggleDarkMode = function() {
                const isDark = clmContainer.getAttribute('data-theme') === 'dark';
                const newMode = isDark ? 'light' : 'dark';
                setTheme(newMode);
            }

            const setTheme = (mode) => {
                if (mode === 'dark') {
                    clmContainer.setAttribute('data-theme', 'dark');
                } else {
                    clmContainer.removeAttribute('data-theme');
                }
                clm_updateToggleIcon(mode === 'dark');
                localStorage.setItem('clm_theme', '' + mode);
            };

            setInterval(() => { els.liveClock.textContent = formatTo12h(nowHMS()); }, 1000);
            setInterval(masterClockTick, 1000);

            els.meetingStart.addEventListener('change', e => { 
                state.cfg.start = e.target.value;
                calculateTargetStartTimes(); 
                save();
            });

            $('#addSegC').addEventListener('click', () => addSegmentToBlock('C'));
            
            els.generateReportBtn.addEventListener('click', () => {
                els.shareModal.style.display = 'flex';
            });
            
            els.confirmResetBtn.addEventListener('click', () => {
                const segmentId = els.resetModal.dataset.segmentIdToReset;
                if (segmentId) {
                    resetSegment(segmentId);
                }
                closeModal(els.resetModal);
            });

            const closeModal = (modal) => {
                modal.style.display = 'none';
            };

            els.cancelResetBtn.addEventListener('click', () => closeModal(els.resetModal));
            els.resetModal.addEventListener('click', (e) => {
                if (e.target === els.resetModal) closeModal(els.resetModal);
            });
            
            els.cancelShareBtn.addEventListener('click', () => closeModal(els.shareModal));
            els.shareModal.addEventListener('click', (e) => {
                if (e.target === els.shareModal) closeModal(els.shareModal);
            });

            els.confirmShareBtn.addEventListener('click', (e) => {
                const options = {
                    includeTimes: els.shareMeetingTimes.checked,
                    includeTreasures: els.shareTreasures.checked,
                    includeMinistry: els.shareMinistry.checked,
                    includeLiving: els.shareLiving.checked,
                    includeOverallVariance: els.shareOverallVariance.checked,
                    includePartTimes: els.sharePartTimes.checked
                };
                const reportText = generateReportText(options);
                copyReport(reportText, els.generateReportBtn);
                closeModal(els.shareModal);
            });

            const savedTheme = localStorage.getItem('clm_theme');
            let initialMode = 'light';
            if (savedTheme) { initialMode = savedTheme; } 
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { initialMode = 'dark'; } 
            
            setTheme(initialMode);
            
            load();

            const expectedTitles = ["Opening Song & Prayer", "Closing Song & Prayer"];
            const hasExpectedSegments = state.segments && Array.isArray(state.segments) && expectedTitles.every(title =>
                state.segments.some(seg => seg.title === title)
            );

            if (!hasExpectedSegments) {
                state.segments = defaultTemplate();
                save(); 
            }
            
            if (!state.cfg.start) state.cfg.start = '19:30';
            
            render();
        })();

    </script>
</body>
</html>

